<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Masterpiece - 관리자 콘솔</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="/static/css/style.css">
    <style>
        @import url('https://cdn.jsdelivr.net/gh/orioncactus/pretendard/dist/web/static/pretendard.css');

        body {
            font-family: 'Pretendard', sans-serif;
            background: #FFFFFF;
            line-height: 1.7;
        }

        .header-gradient {
            background: #000000;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }

        .brand-logo {
            color: #FFFFFF;
            font-weight: 800;
            letter-spacing: -0.03em;
        }

        .card {
            background: #FAFAFA;
            border-radius: 24px;
            transition: all 0.2s ease;
            border: none;
            overflow: hidden;
        }

        .card:hover {
            transform: translateY(-2px);
            background: #F5F5F5;
        }

        .card img {
            transition: transform 0.3s ease;
        }

        .card:hover img {
            transform: scale(1.05);
        }

        .tab-container {
            background: #FAFAFA;
            border-radius: 16px;
            padding: 0.5rem;
            display: inline-flex;
        }

        .tab-button {
            padding: 1rem 1.5rem;
            border-radius: 12px;
            transition: all 0.2s ease;
            font-weight: 600;
            font-size: 1rem;
            color: #6B6B6B;
            border: none;
            background: transparent;
            cursor: pointer;
        }

        .tab-button:hover {
            background-color: #F5F5F5;
        }

        .tab-active {
            background: #000000;
            color: white !important;
            font-weight: 700;
        }

        .action-button {
            padding: 0.75rem 1.25rem;
            border-radius: 12px;
            font-size: 0.9375rem;
            font-weight: 600;
            transition: all 0.2s ease;
            border: none;
            background: #FFFFFF;
            color: #000000;
            cursor: pointer;
        }

        .action-button:hover {
            background: #F5F5F5;
        }

        .action-button:active {
            transform: scale(0.98);
        }

        .action-button-danger {
            background: #FFFFFF;
            color: #FF4040;
        }

        .action-button-danger:hover {
            background: #FFF5F5;
        }

        .action-button-primary {
            background: #000000;
            color: #FFFFFF;
        }

        .action-button-primary:hover {
            background: #1A1A1A;
        }

        .home-button {
            background: white;
            color: #000000;
            padding: 0.875rem 1.5rem;
            border-radius: 12px;
            font-weight: 700;
            border: none;
            transition: all 0.2s ease;
            text-decoration: none;
            display: inline-block;
        }

        .home-button:hover {
            background: #F5F5F5;
        }

        .home-button:active {
            transform: scale(0.98);
        }

        .dialog {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(0, 0, 0, 0.7);
            backdrop-filter: blur(8px);
            z-index: 50;
            align-items: center;
            justify-content: center;
        }

        .dialog-content {
            background-color: white;
            padding: 3rem;
            border-radius: 24px;
            max-width: 400px;
            width: 100%;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
        }

        .photo-preview {
            aspect-ratio: 3/4;
            background: #FAFAFA;
            border-radius: 20px;
            overflow: hidden;
        }
    </style>
</head>
<body class="min-h-screen">
    <header class="header-gradient">
        <div class="container mx-auto py-8 px-6">
            <div class="flex justify-between items-center">
                <div>
                    <h1 class="brand-logo text-5xl md:text-6xl mb-2">Masterpiece</h1>
                    <p class="text-white text-lg font-medium opacity-90">
                        <i class="fas fa-shield-halved mr-2"></i>관리자 콘솔
                    </p>
                </div>
                <a href="/" class="home-button">
                    <i class="fas fa-home mr-2"></i>홈으로
                </a>
            </div>
        </div>
    </header>

    <main class="container mx-auto py-8 px-4">
        <div class="w-full mb-8">
            <div class="flex justify-between items-center mb-6">
                <div class="tab-container flex">
                    <button id="gridViewTab" class="tab-button tab-active" onclick="switchTab('grid')">
                        <i class="fas fa-th-large mr-2"></i>그리드 보기
                    </button>
                    <button id="listViewTab" class="tab-button" onclick="switchTab('list')">
                        <i class="fas fa-list mr-2"></i>리스트 보기
                    </button>
                    <button id="framesTab" class="tab-button" onclick="switchTab('frames')">
                        <i class="fas fa-images mr-2"></i>프레임 관리
                    </button>
                </div>
            </div>

            <div id="gridView" class="mt-6 grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-6">
                <!-- 그리드 뷰 콘텐츠 (JavaScript로 채워짐) -->
                <div class="col-span-full text-center py-12 text-gray-500">
                    세션 데이터를 불러오는 중...
                </div>
    </div>

            <div id="listView" class="mt-6 hidden">
                <div class="bg-white rounded-lg shadow overflow-hidden">
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-gray-50">
                            <tr>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">ID</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">미리보기</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">날짜</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">작업</th>
            </tr>
        </thead>
                        <tbody id="tableBody" class="bg-white divide-y divide-gray-200">
                            <!-- 리스트 뷰 콘텐츠 (JavaScript로 채워짐) -->
                            <tr>
                                <td colspan="5" class="px-6 py-12 text-center text-gray-500">
                                    세션 데이터를 불러오는 중...
                </td>
            </tr>
        </tbody>
    </table>
                </div>
            </div>

            <!-- 프레임 관리 뷰 -->
            <div id="framesView" class="mt-6 hidden">
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                    <!-- 2x2 프레임 -->
                    <div class="bg-white rounded-3xl p-8 shadow">
                        <h3 class="text-2xl font-bold mb-6">2x2 프레임 (104mm x 154mm)</h3>

                        <!-- 업로드 -->
                        <div class="mb-6">
                            <label class="block text-sm font-bold mb-3 text-gray-700">프레임 추가</label>
                            <input type="file" id="adminUpload2x2" accept="image/png"
                                   class="w-full px-4 py-3 rounded-xl border-2 border-gray-200
                                          focus:border-black focus:outline-none">
                            <p class="text-sm text-gray-500 mt-2">
                                PNG 파일만 업로드 가능 (권장 사이즈: 1230 x 1820px)
                            </p>
                            <button onclick="adminUploadFrame('2x2')"
                                    class="mt-4 bg-black hover:bg-gray-800 text-white font-bold px-6 py-3 rounded-xl w-full">
                                <i class="fas fa-upload mr-2"></i>업로드
                            </button>
                        </div>

                        <!-- 프레임 목록 -->
                        <div class="mb-4">
                            <label class="block text-sm font-bold mb-3 text-gray-700">등록된 프레임</label>
                            <div id="adminFrames2x2List" class="space-y-3">
                                <p class="text-gray-400 text-sm">프레임 목록을 불러오는 중...</p>
                            </div>
                        </div>
                    </div>

                    <!-- 1x4 프레임 -->
                    <div class="bg-white rounded-3xl p-8 shadow">
                        <h3 class="text-2xl font-bold mb-6">1x4 프레임 (53mm x 154mm)</h3>

                        <!-- 업로드 -->
                        <div class="mb-6">
                            <label class="block text-sm font-bold mb-3 text-gray-700">프레임 추가</label>
                            <input type="file" id="adminUpload1x4" accept="image/png"
                                   class="w-full px-4 py-3 rounded-xl border-2 border-gray-200
                                          focus:border-black focus:outline-none">
                            <p class="text-sm text-gray-500 mt-2">
                                PNG 파일만 업로드 가능 (권장 사이즈: 630 x 1820px)
                            </p>
                            <button onclick="adminUploadFrame('1x4')"
                                    class="mt-4 bg-black hover:bg-gray-800 text-white font-bold px-6 py-3 rounded-xl w-full">
                                <i class="fas fa-upload mr-2"></i>업로드
                            </button>
                        </div>

                        <!-- 프레임 목록 -->
                        <div class="mb-4">
                            <label class="block text-sm font-bold mb-3 text-gray-700">등록된 프레임</label>
                            <div id="adminFrames1x4List" class="space-y-3">
                                <p class="text-gray-400 text-sm">프레임 목록을 불러오는 중...</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <script>
        // 상태 및 전역 변수
        let currentView = 'grid';
        let sessions = [];
        let selectedSession = null;
        let autoRefreshTimer;
        const REFRESH_INTERVAL = 30000; // 30초마다 자동 새로고침
        const NGROK_DOMAIN = 'tight-scorpion-comic.ngrok-free.app';
        
        // 인증 파라미터 가져오기 
        const urlParams = new URLSearchParams(window.location.search);
        const authParam = urlParams.get('auth');
        
        // 모든 API 요청에 인증 파라미터 추가 함수
        function getAuthUrl(url) {
            if (!authParam) return url;
            return url + (url.includes('?') ? '&' : '?') + 'auth=' + encodeURIComponent(authParam);
        }
        
        // 날짜 포맷팅 함수
        function formatDate(timestamp) {
            const date = new Date(timestamp * 1000);
            return `${date.getFullYear()}년 ${String(date.getMonth() + 1).padStart(2, '0')}월 ${String(date.getDate()).padStart(2, '0')}일 ${String(date.getHours()).padStart(2, '0')}시 ${String(date.getMinutes()).padStart(2, '0')}분`;
        }
        
        // 페이지 로드시 세션 데이터 가져오기
        window.addEventListener('load', function() {
            loadSessions();
            startAutoRefresh();
            
            // 페이지 가시성 변경 시 자동 새로고침 제어
            document.addEventListener('visibilitychange', handleVisibilityChange);
        });
        
        // 자동 새로고침 시작
        function startAutoRefresh() {
            // 기존 타이머가 있으면 제거
            if (autoRefreshTimer) {
                clearInterval(autoRefreshTimer);
            }
            
            // 새 타이머 설정
            autoRefreshTimer = setInterval(() => {
                console.log('자동 새로고침 중...');
                loadSessions();
            }, REFRESH_INTERVAL);
            
            console.log('자동 새로고침 시작');
        }
        
        // 자동 새로고침 중지
        function stopAutoRefresh() {
            if (autoRefreshTimer) {
                clearInterval(autoRefreshTimer);
                autoRefreshTimer = null;
                console.log('자동 새로고침 중지');
            }
        }
        
        // 페이지 가시성 변경 처리
        function handleVisibilityChange() {
            if (document.hidden) {
                // 페이지가 보이지 않을 때는 새로고침 중지
                stopAutoRefresh();
            } else {
                // 페이지가 다시 보일 때는 즉시 새로고침 및 타이머 재시작
                loadSessions();
                startAutoRefresh();
            }
        }
        
        // 세션 데이터 로드
        function loadSessions() {
            fetch(getAuthUrl('/api/photos'))
                .then(response => {
                    if (!response.ok) {
                        throw new Error('서버 오류');
                    }
                    return response.json();
                })
                .then(data => {
                    sessions = data;
                    renderGridView();
                    renderListView();
                })
                .catch(error => {
                    console.error('데이터 로드 오류:', error);
                    showError('세션 데이터를 불러올 수 없습니다');
                });
        }
        
        // 그리드 뷰 렌더링
        function renderGridView() {
            const gridView = document.getElementById('gridView');
            
            if (!sessions || sessions.length === 0) {
                gridView.innerHTML = '<div class="col-span-full text-center py-12 text-gray-500">아직 사진이 없습니다</div>';
                return;
            }
            
            let html = '';
            
            sessions.forEach(session => {
                html += renderGridItem(session);
            });
            
            gridView.innerHTML = html;
        }
        
        function renderGridItem(session) {
            // 세션에 최종 이미지가 없거나 임시 이미지인 경우 건너뜀
            if (!session.final_img || session.final_img.includes('temp_')) return;

            return `
                <div class="card p-0">
                    <div class="photo-preview">
                        <img src="${session.final_img}" alt="Photo ${session.hash}" class="w-full h-full object-cover" onerror="this.onerror=null; this.src='data:image/svg+xml;utf8,<svg xmlns=%22http://www.w3.org/2000/svg%22 width=%22100%%22 height=%22100%%22 viewBox=%220 0 100 100%22><rect width=%22100%%22 height=%22100%%22 fill=%22%23f3f4f6%22></rect><text x=%2250%%22 y=%2250%%22 font-family=%22sans-serif%22 font-size=%2216%22 text-anchor=%22middle%22 dominant-baseline=%22middle%22 fill=%22%23d1d5db%22>이미지 없음</text></svg>'">
                    </div>
                    <div class="p-6">
                        <div class="mb-4">
                            <div class="text-xs text-gray-400 mb-1 font-medium">세션 ID</div>
                            <div class="text-base font-bold text-gray-800 truncate">${session.hash}</div>
                        </div>
                        <div class="mb-6">
                            <div class="text-xs text-gray-400 mb-1 font-medium">촬영 일시</div>
                            <div class="text-sm font-medium text-gray-600">${formatDate(session.created_at)}</div>
                        </div>
                        <div class="flex flex-col gap-3">
                            <button class="action-button action-button-primary w-full text-center" onclick="showQrCode('${session.hash}')">
                                <i class="fas fa-qrcode mr-2"></i>QR 코드
                            </button>
                            <div class="flex gap-3">
                                <a href="${session.final_img}" download class="action-button flex-1 text-center">
                                    <i class="fas fa-download mr-1"></i>저장
                                </a>
                                <button class="action-button action-button-danger flex-1" onclick="deleteSession('${session.hash}')">
                                    <i class="fas fa-trash-alt mr-1"></i>삭제
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }
        
        // 리스트 뷰 렌더링
        function renderListView() {
            const tableBody = document.getElementById('tableBody');
            let html = '';
            
            if (sessions.length === 0) {
                html = `
                    <tr>
                        <td colspan="5" class="px-6 py-12 text-center text-gray-500">
                            표시할 세션이 없습니다
                        </td>
                    </tr>
                `;
            } else {
                sessions.forEach(session => {
                    // 세션에 최종 이미지가 없거나 임시 이미지인 경우 건너뜀
                    if (!session.final_img || session.final_img.includes('temp_')) return;
                    
                    html += `
                        <tr>
                            <td class="px-6 py-4 whitespace-nowrap">
                                <div class="text-sm text-gray-900">${session.hash}</div>
                            </td>
                            <td class="px-6 py-4 whitespace-nowrap">
                                <div class="w-16 h-16 overflow-hidden rounded">
                                    <img src="${session.final_img}" alt="Photo ${session.hash}" class="w-full h-full object-cover rounded" onerror="this.onerror=null; this.src='data:image/svg+xml;utf8,<svg xmlns=%22http://www.w3.org/2000/svg%22 width=%22100%%22 height=%22100%%22 viewBox=%220 0 100 100%22><rect width=%22100%%22 height=%22100%%22 fill=%22%23f3f4f6%22></rect><text x=%2250%%22 y=%2250%%22 font-family=%22sans-serif%22 font-size=%2212%22 text-anchor=%22middle%22 dominant-baseline=%22middle%22 fill=%22%23d1d5db%22>No Image</text></svg>'">
                                </div>
                            </td>
                            <td class="px-6 py-4 whitespace-nowrap">
                                <div class="text-sm text-gray-900">${formatDate(session.created_at)}</div>
                            </td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm">
                                <button class="text-rose-600 hover:text-rose-800" onclick="showQrCode('${session.hash}')">
                                    <i class="fas fa-qrcode mr-1"></i> QR 코드 보기
                                </button>
                            </td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                                <div class="flex gap-2">
                                    <a href="${session.final_img}" download class="text-gray-600 hover:text-gray-800">
                                        <i class="fas fa-download mr-1"></i> 다운로드
                                    </a>
                                    <button class="text-rose-600 hover:text-rose-800" onclick="deleteSession('${session.hash}')">
                                        <i class="fas fa-trash-alt mr-1"></i> 삭제
                                    </button>
                                </div>
                            </td>
                        </tr>
                    `;
                });
            }
            
            tableBody.innerHTML = html;
        }
        
        // 탭 전환
        function switchTab(viewType) {
            currentView = viewType;

            // 탭 상태 업데이트
            document.getElementById('gridViewTab').classList.toggle('tab-active', viewType === 'grid');
            document.getElementById('listViewTab').classList.toggle('tab-active', viewType === 'list');
            document.getElementById('framesTab').classList.toggle('tab-active', viewType === 'frames');

            // 뷰 표시/숨김
            document.getElementById('gridView').style.display = viewType === 'grid' ? 'grid' : 'none';
            document.getElementById('listView').style.display = viewType === 'list' ? 'block' : 'none';
            document.getElementById('framesView').style.display = viewType === 'frames' ? 'block' : 'none';

            // 프레임 탭 열릴 때 프레임 목록 로드
            if (viewType === 'frames') {
                adminLoadFrames('2x2');
                adminLoadFrames('1x4');
            }
        }
        
        // 클립보드에 복사
        function copyToClipboard(text) {
            navigator.clipboard.writeText(text).then(() => {
                alert('링크가 클립보드에 복사되었습니다.');
            }).catch(err => {
                console.error('클립보드 복사 실패:', err);
            });
        }
        
        // 세션 삭제
        function deleteSession(hash) {
            if (!confirm('정말로 이 세션을 삭제하시겠습니까? 이 작업은 되돌릴 수 없습니다.')) {
                return;
            }
            
            // 로딩 표시
            showLoading();
            
            // 삭제 API 호출 (인증 정보 포함)
            fetch(getAuthUrl(`/api/delete-session/${hash}`), {
                method: 'DELETE'
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error('삭제 실패');
                }
                return response.json();
            })
            .then(data => {
                if (data.success) {
                    // 성공 시 세션 목록 새로고침
                    loadSessions();
                    showSuccess(`세션이 삭제되었습니다: ${data.message}`);
                } else {
                    showError(data.error || '알 수 없는 오류');
                }
            })
            .catch(error => {
                console.error('삭제 오류:', error);
                showError('세션을 삭제하는 중 오류가 발생했습니다');
            })
            .finally(() => {
                hideLoading();
            });
        }
        
        // 로딩 표시
        function showLoading() {
            const loadingDiv = document.createElement('div');
            loadingDiv.id = 'loadingOverlay';
            loadingDiv.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                right: 0;
                bottom: 0;
                background: rgba(0, 0, 0, 0.5);
                display: flex;
                align-items: center;
                justify-content: center;
                z-index: 1000;
            `;
            loadingDiv.innerHTML = `
                <div style="background: white; padding: 20px; border-radius: 8px; text-align: center;">
                    <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-rose-600 mx-auto"></div>
                    <p class="mt-2">처리 중...</p>
                </div>
            `;
            document.body.appendChild(loadingDiv);
        }

        // 로딩 숨기기
        function hideLoading() {
            const loadingDiv = document.getElementById('loadingOverlay');
            if (loadingDiv) {
                loadingDiv.remove();
            }
        }

        // 성공 메시지 표시
        function showSuccess(message) {
            const statusMessage = document.getElementById('statusMessage');
            statusMessage.textContent = message;
            statusMessage.className = 'status-success';
            statusMessage.style.display = 'block';
            setTimeout(() => {
                statusMessage.style.display = 'none';
            }, 3000);
        }

        // 오류 메시지 표시
        function showError(message) {
            const statusMessage = document.getElementById('statusMessage');
            statusMessage.textContent = message;
            statusMessage.className = 'status-error';
            statusMessage.style.display = 'block';
            setTimeout(() => {
                statusMessage.style.display = 'none';
            }, 3000);
        }

        // 프레임 목록 불러오기 (관리자)
        async function adminLoadFrames(layout) {
            try {
                const response = await fetch(`/api/frames/${layout}`);
                const data = await response.json();

                const listId = layout === '2x2' ? 'adminFrames2x2List' : 'adminFrames1x4List';
                const listEl = document.getElementById(listId);

                if (data.success && data.frames.length > 0) {
                    listEl.innerHTML = data.frames.map(frame => `
                        <div class="flex items-center justify-between p-4 bg-gray-50 rounded-xl hover:bg-gray-100 transition">
                            <div class="flex items-center gap-4">
                                <div class="w-16 h-24 bg-white rounded border border-gray-200 flex items-center justify-center overflow-hidden">
                                    <img src="${frame.path}" alt="${frame.name}"
                                         class="w-full h-full object-contain">
                                </div>
                                <span class="font-semibold text-gray-800">${frame.name}</span>
                            </div>
                            <button onclick="adminDeleteFrame('${layout}', '${frame.name}')"
                                    class="bg-red-500 hover:bg-red-600 text-white font-bold px-4 py-2 rounded-lg transition">
                                <i class="fas fa-trash mr-1"></i>삭제
                            </button>
                        </div>
                    `).join('');
                } else {
                    listEl.innerHTML = '<p class="text-gray-400 text-sm text-center py-4">등록된 프레임이 없습니다.</p>';
                }
            } catch (error) {
                console.error(`프레임 목록 로드 실패 (${layout}):`, error);
                const listId = layout === '2x2' ? 'adminFrames2x2List' : 'adminFrames1x4List';
                document.getElementById(listId).innerHTML = '<p class="text-red-500 text-sm text-center py-4">프레임 목록을 불러올 수 없습니다.</p>';
            }
        }

        // 프레임 업로드 (관리자)
        async function adminUploadFrame(layout) {
            const inputId = layout === '2x2' ? 'adminUpload2x2' : 'adminUpload1x4';
            const fileInput = document.getElementById(inputId);
            const file = fileInput.files[0];

            if (!file) {
                alert('파일을 선택해주세요.');
                return;
            }

            if (!file.type.includes('png')) {
                alert('PNG 파일만 업로드 가능합니다.');
                return;
            }

            const formData = new FormData();
            formData.append('frame', file);
            formData.append('layout', layout);

            try {
                showLoading();
                const response = await fetch('/api/frames/upload', {
                    method: 'POST',
                    body: formData
                });

                const data = await response.json();

                if (data.success) {
                    showSuccess('프레임이 업로드되었습니다!');
                    fileInput.value = '';
                    adminLoadFrames(layout);
                } else {
                    showError('업로드 실패: ' + (data.error || '알 수 없는 오류'));
                }
            } catch (error) {
                console.error('프레임 업로드 오류:', error);
                showError('프레임 업로드 중 오류가 발생했습니다.');
            } finally {
                hideLoading();
            }
        }

        // 프레임 삭제 (관리자)
        async function adminDeleteFrame(layout, filename) {
            if (!confirm(`${filename}을(를) 삭제하시겠습니까?`)) {
                return;
            }

            try {
                showLoading();
                const response = await fetch(`/api/frames/${layout}/${filename}`, {
                    method: 'DELETE'
                });

                const data = await response.json();

                if (data.success) {
                    showSuccess('프레임이 삭제되었습니다.');
                    adminLoadFrames(layout);
                } else {
                    showError('삭제 실패: ' + (data.error || '알 수 없는 오류'));
                }
            } catch (error) {
                console.error('프레임 삭제 오류:', error);
                showError('프레임 삭제 중 오류가 발생했습니다.');
            } finally {
                hideLoading();
            }
        }

        // 다이얼로그 외부 클릭 시 닫기
        window.addEventListener('click', function(event) {
            const dialog = document.getElementById('qrDialog');
            if (event.target === dialog) {
                closeQrDialog();
            }
        });
    </script>
</body>
</html> 